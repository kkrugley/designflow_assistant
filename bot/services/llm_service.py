# file: bot/services/llm_service.py

import httpx
from bot.config import settings

# –í–∞—à–∏ –ø—Ä–æ–º–ø—Ç—ã –∏–∑ –¢–ó
PDF_CARD_PROMPT = """–ù–∞–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –Ω–∏–∂–µ. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ç–æ–Ω.
- –ß—ë—Ç–∫–æ –æ–ø–∏—Å–∞—Ç—å –∏–¥–µ—é –ø—Ä–æ–µ–∫—Ç–∞, –µ–≥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∏ –ø—Ä–µ–¥–º–µ—Ç –¥–∏–∑–∞–π–Ω–∞.
- –û–±—ä—è—Å–Ω–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–µ–¥–º–µ—Ç–∞.
- –í–∫–ª—é—á–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –ª–µ–∫—Å–∏–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: —ç—Ä–≥–æ–Ω–æ–º–∏–∫–∞, –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å).
- –ë—ã—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ —É—Ä–æ–≤–Ω—è B1-B2 (–ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –±–∞–∑–æ–≤—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã).
- –ò–º–µ—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É:
        - –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞ (1 —Å—Ç—Ä–æ–∫–∞).
        - –û–ø–∏—Å–∞–Ω–∏–µ –∏–¥–µ–∏ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
        - –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–º–∞—Ç–µ—Ä–∏–∞–ª—ã/—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
        - –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–º–µ—Ç–∞ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
–ß–µ—Ä–Ω–æ–≤–∏–∫: [Draft]"""

SOCIAL_MEDIA_PROMPT = """–°–æ–∑–¥–∞–π –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π (TikTok/Instagram) –Ω–∞ –æ—Å–Ω–æ–≤–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –Ω–∏–∂–µ. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω:
- –ë—ã—Ç—å –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ engaging (–∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ üòä).
- –ö—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞—Ç—å –∏–¥–µ—é –ø—Ä–æ–µ–∫—Ç–∞, –ø—Ä–µ–¥–º–µ—Ç –¥–∏–∑–∞–π–Ω–∞ –∏ –µ–≥–æ —Ñ—É–Ω–∫—Ü–∏—é.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –ª–µ–∫—Å–∏–∫—É —É–ø—Ä–æ—â—ë–Ω–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "—ç—Ä–≥–æ–Ω–æ–º–∏—á–Ω—ã–π –¥–∏–∑–∞–π–Ω", "–∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã").
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–º—É —É—Ä–æ–≤–Ω—é B1-B2 (–∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –ø—Ä–æ—Å—Ç—ã–µ –≥–ª–∞–≥–æ–ª—ã).
- –£–∫–ª–∞–¥—ã–≤–∞—Ç—å—Å—è –≤ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è + —Ö—ç—à—Ç–µ–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: #IndustrialDesign #Innovation + –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∫ –ø—Ä–æ–µ–∫—Ç—É —Ö—ç—à—Ç–µ–≥–∏).
–ß–µ—Ä–Ω–æ–≤–∏–∫: [Draft]"""

async def generate_text_from_draft(prompt_template: str, draft: str) -> str | None:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å –ø–æ–º–æ—â—å—é LLM API (Gemini).

    :param prompt_template: –®–∞–±–ª–æ–Ω –ø—Ä–æ–º–ø—Ç–∞ (PDF_CARD_PROMPT –∏–ª–∏ SOCIAL_MEDIA_PROMPT).
    :param draft: –ß–µ—Ä–Ω–æ–≤–∏–∫ —Ç–µ–∫—Å—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    :return: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
    """
    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ –≤ –ø—Ä–æ–º–ø—Ç
    final_prompt = prompt_template.replace("[Draft]", draft)

    headers = {
        "Content-Type": "application/json",
    }
    
    # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è Gemini API
    json_data = {
        "contents": [{
            "parts": [{"text": final_prompt}]
        }]
    }
    
    # URL —Å –∫–ª—é—á–æ–º API
    url = f"{settings.llm_api_endpoint}?key={settings.llm_api_key}"

    try:
        async with httpx.AsyncClient(timeout=60.0) as client:
            response = await client.post(url, headers=headers, json=json_data)
            response.raise_for_status() # –í—ã–∑–æ–≤–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –∫–æ–¥–æ–≤ 4xx/5xx
            
            data = response.json()
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —Å–ª–æ–∂–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞ Gemini
            generated_text = data["candidates"][0]["content"]["parts"][0]["text"]
            return generated_text.strip()
            
    except httpx.HTTPStatusError as e:
        print(f"–û—à–∏–±–∫–∞ HTTP –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ LLM API: {e.response.status_code} - {e.response.text}")
        return None
    except Exception as e:
        print(f"–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ LLM API: {e}")
        return None
